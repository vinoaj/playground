<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Tester</title>

    <style>
        body {
            font-family: sans-serif;
        }
    </style>

    <!-- Google Tag Manager -->
    <script>
        (function (w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({
                'gtm.start': new Date().getTime(),
                event: 'gtm.js'
            });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src =
                'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-KRDJQ35');
    </script>
    <!-- End Google Tag Manager -->
    <script>
        function checkGTMLoad() {
            console.log("1: ", window['google_tag_manager']);
            if (!window['google_tag_manager']) {
                console.log('GTM did not load');
                payload = {
                    tid: 'UA-108507372-1',
                    dp: '/GTM_not_fired'
                }

                var endpoint = 'https://us-central1-phrasal-charger-185822.cloudfunctions.net/relayMPHit';
                var httpRequest = new XMLHttpRequest();
                httpRequest.open('POST', endpoint);
                httpRequest.setRequestHeader('Content-Type', 'application/json');
                httpRequest.send(JSON.stringify(payload));
            } else {
                console.log("DOM fully loaded and parsed");
            }
        }

        function assessState() {
            console.log("assessState => document.readyState: ", document.readyState);

            switch (document.readyState) {
                case 'loading':
                    // document.addEventListener('DOMContentLoaded', checkGTMLoad);
                    document.addEventListener('onreadystatechange', assessState)
                    break;
                case 'interactive':
                case 'complete':
                    checkGTMLoad();
                    break;
            }
        }

        assessState();
        console.log("document.readyState: ", document.readyState);

    </script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
</head>

<body>
    <h1>GTM fired vs. non-fired test</h1>
</body>

</html>
